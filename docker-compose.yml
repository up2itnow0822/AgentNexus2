# AgentNexus Docker Compose Configuration
# Run: docker-compose up -d

services:
  # PostgreSQL Database with pgvector extension
  agentnexus-postgres:
    image: pgvector/pgvector:pg16
    container_name: agentnexus-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: agentnexus
      POSTGRES_USER: agentnexus
      POSTGRES_PASSWORD: ${DB_PASSWORD:-devpassword}
    ports:
      - "5432:5432"
    volumes:
      - agentnexus_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U agentnexus" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache for sessions and real-time data
  agentnexus-redis:
    image: redis:7-alpine
    container_name: agentnexus-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - agentnexus_redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

  # Backend API Server (Express + WebSocket)
  agentnexus-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runner
    container_name: agentnexus-backend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://agentnexus:${DB_PASSWORD:-devpassword}@agentnexus-postgres:5432/agentnexus
      REDIS_URL: redis://agentnexus-redis:6379
      PORT: 3001
      # Smart Contract Addresses (Base Sepolia)
      ESCROW_CONTRACT_ADDRESS: "0x14F12c3F36DD6Fa860E21f7D51f696231057A8a0"
      ENTITLEMENTS_CONTRACT_ADDRESS: "0x1662AeCE70441B8482e09f04D3Ef3954a8E26C0d"
      # Docker connection for agent execution
      DOCKER_HOST: tcp://agentnexus-agent-runtime:2375
    ports:
      - "3001:3001"
    depends_on:
      agentnexus-postgres:
        condition: service_healthy
      agentnexus-redis:
        condition: service_healthy

  # Agent Runtime (Docker-in-Docker) - For containerized agent execution
  # ⚠️ SECURITY NOTE: privileged:true is required for DIND but grants elevated access
  # PRODUCTION ALTERNATIVES:
  #   1. Use Kubernetes with containerd instead of DIND
  #   2. Use Sysbox runtime (rootless containers)
  #   3. Use remote Docker daemon with mTLS
  agentnexus-agent-runtime:
    image: docker:24-dind
    container_name: agentnexus-agent-runtime
    privileged: true # Required for DIND - see security note above
    restart: unless-stopped
    environment:
      DOCKER_TLS_CERTDIR: "" # Disable TLS for internal comms
    volumes:
      - agentnexus_agent_runtime_data:/var/lib/docker
    ports:
      - "2375:2375"
    # Security hardening for DIND
    security_opt:
      - seccomp:unconfined
    cap_drop:
      - NET_RAW

volumes:
  agentnexus_postgres_data:
    driver: local
  agentnexus_redis_data:
    driver: local
  agentnexus_agent_runtime_data:
    driver: local

networks:
  default:
    name: agentnexus-network
