name: CI Suite

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, develop, refactor/* ]

jobs:
  unit-tests-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - run: npm install
      - run: npm test --if-present

  unit-tests-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - run: pnpm install --frozen-lockfile || pnpm install
      - run: pnpm build || echo "No build script defined"
      - run: pnpm test --if-present || echo "No frontend tests"

  smart-contracts-foundry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      - name: Run Foundry tests
        run: |
          if [ -d contracts ]; then cd contracts && forge test -vvv || true; cd -; fi
          if [ -d smart-contracts ]; then cd smart-contracts && forge test -vvv || true; cd -; fi

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build backend image
        run: |
          if [ -f backend/Dockerfile ]; then docker build -t agentnexus/backend:ci ./backend; else echo "No backend Dockerfile"; fi
      - name: Build frontend image
        run: |
          if [ -f frontend/Dockerfile ]; then docker build -t agentnexus/frontend:ci ./frontend; else echo "No frontend Dockerfile"; fi

  smoke-backend:
    needs: [unit-tests-backend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - name: Install & start backend (dev)
        working-directory: backend
        run: |
          npm install || true
          npm run build --if-present || true
          npm start --if-present &
          npx wait-on http://localhost:3000 || true
      - name: Ping health
        run: |
          curl -fsS http://localhost:3000/health || echo "Health endpoint not available"
